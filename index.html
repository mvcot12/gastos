<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Plan de Viaje</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
 --glass:rgba(255,255,255,.28);
 --blur:blur(16px);
 --accent:#2f3c7e;
 --p1:#f6f4ff;
 --p2:#d2e4fa;
}
*{box-sizing:border-box}
body{margin:0;padding:1rem;font-family:-apple-system,Helvetica,Arial,sans-serif;
     background:linear-gradient(135deg,var(--p1),var(--p2));color:#222;}
header{backdrop-filter:var(--blur);background:var(--glass);border-radius:20px;
       padding:1rem;margin-bottom:1.2rem;box-shadow:0 4px 20px rgba(0,0,0,.15)}
h1{margin:0;font-size:1.45rem;color:var(--accent)}
.countdown{font-family:monospace;font-size:1rem;text-align:center;margin-top:.4rem}
.grid{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem}
.card{flex:1 1 155px;background:var(--glass);backdrop-filter:var(--blur);
      padding:.9rem;border-radius:18px;text-align:center;box-shadow:0 1px 6px rgba(0,0,0,.12)}
.card h2{margin:.2rem 0;font-size:.92rem;color:var(--accent)}
input,select,button{width:100%;padding:.55rem;margin-top:.35rem;border-radius:12px;
                    border:1px solid #ccc;font-size:.9rem}
button{background:var(--accent);color:#fff;border:none;cursor:pointer}
details{margin-bottom:1rem}
summary{cursor:pointer;font-weight:600;margin-bottom:.5rem}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{padding:.35rem;border-bottom:1px solid #ddd;text-align:left}
tr.done td{opacity:.5;text-decoration:line-through}
#lista li{margin:.25rem 0}
fieldset{border:none;padding:0;margin:0}
@media(max-width:480px){.card{flex:1 1 120px}}
</style>
</head>
<body>

<header>
  <h1>Plan de Viaje</h1>
  <div id="countdown" class="countdown">Sin configuraci√≥n</div>
</header>

<!-- ==== RESUMEN PRINCIPAL ==== -->
<section class="grid" id="mainSummary">
  <div class="card"><h2>Presupuesto plan</h2><span id="sumBudget">$0</span></div>
  <div class="card"><h2>Gastado real</h2><span id="sumSpent">$0</span></div>
  <div class="card"><h2>Diferencia</h2><span id="sumDiff">$0</span></div>
  <div class="card"><h2>Extra disponible</h2><span id="sumExtra">$0</span></div>
</section>

<section class="grid" id="cardSummary">
  <div class="card"><h2>Pichincha total</h2><span id="pTotal">$0</span></div>
  <div class="card"><h2>Pac√≠fico total</h2><span id="bTotal">$0</span></div>
  <div class="card"><h2>Pichincha ropa</h2><span id="pRopa">$0</span></div>
  <div class="card"><h2>Pac√≠fico ropa</h2><span id="bRopa">$0</span></div>
  <div class="card"><h2>Gasolina saldo</h2><span id="gasSaldo">$0</span></div>
  <div class="card"><h2>Propinas saldo</h2><span id="propSaldo">$0</span></div>
  <div class="card"><h2>Variaci√≥n plan</h2><span id="planDelta">$0</span></div>
</section>

<!-- ==== CONFIGURAR VIAJE ==== -->
<details id="configBox" open>
  <summary>üóìÔ∏è Configurar viaje</summary>
  <fieldset>
    <label>Fecha inicio</label><input type="date"  id="tripStart">
    <label>Fecha fin</label><input type="date"      id="tripEnd">
    <label>Fecha l√≠mite edici√≥n plan</label><input type="date" id="tripLock">

    <label>Saldo inicial Tarjeta Pichincha (total)</label>
    <input type="number" id="pIni" step="0.01" placeholder="ej. 1200">
    <label>Saldo inicial Tarjeta Pac√≠fico (total)</label>
    <input type="number" id="bIni" step="0.01" placeholder="ej. 1000">

    <label>Fondo total Gasolina</label><input type="number" id="gasIni" step="0.01" placeholder="ej. 100">
    <label>Fondo total Propinas</label><input type="number" id="propIni" step="0.01" placeholder="ej. 200">
    <label>Fondo total Ropa</label><input type="number" id="ropaIni" step="0.01" placeholder="ej. 600">

    <button type="button" onclick="saveTrip()">Guardar viaje</button>
  </fieldset>
</details>

<!-- ==== PLANIFICACI√ìN ==== -->
<details id="planBlock">
  <summary>üìù Planificaci√≥n (editable hasta fecha l√≠mite)</summary>

  <!-- tabla -->
  <table id="planTbl">
    <thead><tr>
      <th>Fecha</th><th>Categor√≠a</th><th>Monto</th>
      <th>M√©todo</th><th>Tarjeta</th><th>Real</th><th></th>
    </tr></thead>
    <tbody></tbody>
  </table>

  <!-- formulario a√±adir fila -->
  <fieldset>
    <input type="date" id="pDate">

    <select id="pCat"></select>

    <input type="number" id="pMonto" step="0.01" placeholder="$">

    <select id="pPay">
      <option value="Efectivo">Efectivo</option>
      <option value="Debito">D√©bito</option>
      <option value="Credito">Cr√©dito</option>
    </select>

    <select id="pTarj" style="display:none">
      <option value="Pichincha">Pichincha</option>
      <option value="Pacifico">Pac√≠fico</option>
    </select>

    <button type="button" onclick="addPlan()">A√±adir plan</button>
  </fieldset>
</details>

<!-- ==== GASTO REAL ==== -->
<details id="realBlock" open>
  <summary>‚ûï Registrar gasto real</summary>
  <fieldset>
    <label>Fecha</label><input type="date" id="gDate">
    <label>Categor√≠a</label><select id="gCat"></select>
    <label>Monto</label><input type="number" id="gAmount" step="0.01">

    <label>M√©todo pago</label>
    <select id="gPay">
      <option value="Efectivo">Efectivo</option>
      <option value="Debito">D√©bito</option>
      <option value="Credito">Cr√©dito</option>
    </select>

    <label id="gTarjLbl" style="display:none">Tarjeta</label>
    <select id="gTarj" style="display:none">
      <option value="Pichincha">Pichincha</option>
      <option value="Pacifico">Pac√≠fico</option>
    </select>

    <label>¬øUsa extra?</label>
    <select id="gExtra">
      <option value="no">No</option><option value="si">S√≠</option>
    </select>
    <label id="motivoLbl" style="display:none">Motivo extra</label>
    <input  id="motivoTxt" style="display:none">

    <button type="button" onclick="addGasto()">Guardar gasto</button>
  </fieldset>
</details>

<!-- ==== LISTA DE GASTOS ==== -->
<details>
  <summary>üóíÔ∏è Gastos registrados</summary>
  <ul id="lista"></ul>
</details>

<script>
/* === CONSTANTES === */
const CATS_FIXED = ["Buseta","Alquiler de carro","Hotel","GOLO","Entretenimiento",
                    "Comida","Aeropuerto","Snacks","Extras paseo","Transporte","Parqueo"];
const CATS_POOL  = ["Ropa","Propinas","Gasolina"];
const LS = "planViajeDataV3";

/* === DATOS ================================================================= */
let data = JSON.parse(localStorage.getItem(LS)||'{"meta":{},"plan":[],"gastos":[]}');

/* === UTILIDADES ============================================================ */
const fmt = n=>'$'+(+n).toFixed(2);
function save(){ localStorage.setItem(LS,JSON.stringify(data)); }

/* === SELECTS DE CATEGOR√çA ================================================== */
function fillCatSelect(sel){
  sel.innerHTML = [...CATS_FIXED,...CATS_POOL]
     .map(c=>`<option value="${c}">${c}</option>`).join("");
}
fillCatSelect(document.getElementById('pCat'));
fillCatSelect(document.getElementById('gCat'));

/* === CONFIGURAR VIAJE ====================================================== */
function saveTrip(){
  const m = data.meta = {
    start: document.getElementById('tripStart').value,
    end:   document.getElementById('tripEnd').value,
    lock:  document.getElementById('tripLock').value,
    pIni:  parseFloat(document.getElementById('pIni').value||0),
    bIni:  parseFloat(document.getElementById('bIni').value||0),
    gasIni: parseFloat(document.getElementById('gasIni').value||0),
    propIni:parseFloat(document.getElementById('propIni').value||0),
    ropaIni: parseFloat(document.getElementById('ropaIni').value||0)
  };
  save(); renderUI(); tick();
  // Ocultar config una vez guardado
  document.getElementById('configBox').open=false;
}

/* === PLANIFICACI√ìN ======================================================== */
function addPlan(){
  const f = document.getElementById('pDate').value;
  const cat = document.getElementById('pCat').value;
  const monto = parseFloat(document.getElementById('pMonto').value||'0');
  const pay = document.getElementById('pPay').value;
  const tarj = pay==="Credito" ? document.getElementById('pTarj').value : "";
  if((CATS_FIXED.includes(cat)&&!f) || !monto){
     alert('Fecha y monto son obligatorios');return;}
  data.plan.push({id:crypto.randomUUID(),fecha:f,cat,monto,metodo:pay,tarjeta:tarj,real:0,done:false});
  save(); renderPlanTable();
  document.getElementById('pMonto').value='';
}
function toggleDone(id){ /* marcar manual */
  const p = data.plan.find(x=>x.id===id); if(!p)return;
  p.done = !p.done; save(); renderPlanTable(); updateSummary();
}
function registrarReal(id,val){
  const p = data.plan.find(x=>x.id===id); if(!p)return;
  p.real = parseFloat(val)||0; p.done = p.real>0;
  save(); renderPlanTable(); updateSummary();
}
function renderPlanTable(){
  const tb = document.querySelector('#planTbl tbody'); tb.innerHTML='';
  data.plan.sort((a,b)=>a.fecha.localeCompare(b.fecha)).forEach(p=>{
    const tr=document.createElement('tr');
    if(p.done) tr.classList.add('done');
    tr.innerHTML=`<td>${p.fecha||'-'}</td><td>${p.cat}</td><td>${fmt(p.monto)}</td>
      <td>${p.metodo}</td><td>${p.tarjeta||'-'}</td>
      <td><input type="number" step="0.01" min="0" value="${p.real||''}"
           oninput="registrarReal('${p.id}',this.value)"></td>
      <td><input type="checkbox" ${p.done?'checked':''}
           onclick="toggleDone('${p.id}')"></td>`;
    tb.appendChild(tr);
  });
}

/* === GASTO REAL =========================================================== */
function addGasto(){
  const f = document.getElementById('gDate').value;
  const cat = document.getElementById('gCat').value;
  const monto = parseFloat(document.getElementById('gAmount').value||'0');
  const metodo = document.getElementById('gPay').value;
  const tarjeta = metodo==="Credito" ? document.getElementById('gTarj').value : "";
  const ex = document.getElementById('gExtra').value==='si';
  const mot = document.getElementById('motivoTxt').value.trim();
  if(!f||!monto){alert('Completa fecha y monto');return;}

  data.gastos.push({fecha:f,cat,monto,metodo,tarjeta,extra:ex,motivo:mot});
  /* match plan fijo */
  const plan = data.plan.find(p=>!p.done && p.cat===cat &&
                                (p.fecha===f || CATS_POOL.includes(cat)));
  if(plan){ plan.done=true; plan.real=monto; }
  save(); renderList(); updateSummary();
  document.getElementById('gAmount').value='';
  document.getElementById('motivoTxt').value='';
}

/* === RENDER LISTA GASTOS ================================================== */
function renderList(){
  const ul=document.getElementById('lista'); ul.innerHTML='';
  data.gastos.forEach(g=>{
    const li=document.createElement('li');
    li.textContent=`${g.fecha} ‚Ä¢ ${g.cat} ‚Ä¢ ${fmt(g.monto)} ‚Ä¢ ${g.metodo}${g.tarjeta?'-'+g.tarjeta:''}${g.extra?' ‚Ä¢ extra:'+g.motivo:''}`;
    ul.appendChild(li);
  });
}

/* === RESUMEN & SALDOS ===================================================== */
function updateSummary(){
  /* totales plan */
  const planTotal = data.plan.reduce((s,p)=>s+p.monto,0);
  /* totales gastados */
  const gastado = data.gastos.reduce((s,g)=>s+g.monto,0);
  /* diferencia plan vs real */
  document.getElementById('sumBudget').textContent=fmt(planTotal);
  document.getElementById('sumSpent').textContent=fmt(gastado);
  document.getElementById('sumDiff').textContent=fmt(planTotal-gastado);

  /* tarjetas globales */
  let pG=0,bG=0, pR=0,bR=0;
  data.gastos.forEach(g=>{
    if(g.metodo==="Credito"){
      if(g.tarjeta==="Pichincha"){pG+=g.monto;if(g.cat==="Ropa")pR+=g.monto;}
      if(g.tarjeta==="Pacifico"){bG+=g.monto;if(g.cat==="Ropa")bR+=g.monto;}
    }
  });
  const m=data.meta;
  document.getElementById('pTotal').textContent=fmt((m.pIni||0)-pG);
  document.getElementById('bTotal').textContent=fmt((m.bIni||0)-bG);
  document.getElementById('pRopa').textContent=fmt((m.ropaIni||0)-pR);
  document.getElementById('bRopa').textContent=fmt((m.ropaIni||0)-bR);

  /* fondos gasolina/propinas */
  let gGast=0, prGast=0;
  data.gastos.forEach(g=>{
    if(g.cat==="Gasolina") gGast+=g.monto;
    if(g.cat==="Propinas") prGast+=g.monto;
  });
  document.getElementById('gasSaldo').textContent=fmt((m.gasIni||0)-gGast);
  document.getElementById('propSaldo').textContent=fmt((m.propIni||0)-prGast);

  /* variaci√≥n plan */
  let delta=0;
  data.plan.forEach(p=>{
    if(p.real){
      delta += p.real - p.monto;
    }
  });
  document.getElementById('planDelta').textContent=fmt(delta);

  /* mover planes fijos no ejecutados a extra */
  const hoy=new Date().toISOString().slice(0,10);
  data.plan.forEach(p=>{
    if(!p.done && p.fecha && p.fecha<hoy){
      p.done=true;
      data.meta.extra = (data.meta.extra||0) + p.monto;
    }
  });
  document.getElementById('sumExtra').textContent=fmt(data.meta.extra||0);

  save(); renderPlanTable();
}

/* === CUENTA REGRESIVA ===================================================== */
function tick(){
  if(!data.meta.start){return;}
  const target=new Date(data.meta.start+'T00:00:00').getTime();
  const now=Date.now(); let diff=target-now;
  const el=document.getElementById('countdown');
  if(diff<=0){el.textContent='¬°Viaje en curso!';return;}
  const d=Math.floor(diff/864e5); diff%=864e5;
  const h=Math.floor(diff/36e5); diff%=36e5;
  const m=Math.floor(diff/6e4); diff%=6e4;
  const s=Math.floor(diff/1e3);
  el.textContent=`${d}d ${h}h ${m}m ${s}s`;
}

/* === CONTROL UI SEG√öN METADATOS ========================================== */
function renderUI(){
  /* rellena selects visibles */
  fillCatSelect(document.getElementById('pCat'));
  fillCatSelect(document.getElementById('gCat'));

  const today=new Date().toISOString().slice(0,10);
  if(data.meta.lock && today>data.meta.lock){
    /* ocultar plan inputs */
    document.querySelectorAll('#planBlock input, #planBlock select, #planBlock button')
      .forEach(el=>el.disabled=true);
  }
  /* pre-llenar meta en formularios si existe */
  ['tripStart','tripEnd','tripLock','pIni','bIni','gasIni','propIni','ropaIni']
    .forEach(id=>{ if(data.meta[id]) document.getElementById(id).value=data.meta[id]; });

  renderPlanTable(); renderList(); updateSummary();
}

/* === EVENTOS UI =========================================================== */
document.getElementById('pPay').addEventListener('change',e=>{
  document.getElementById('pTarj').style.display =
    e.target.value==="Credito" ? 'block':'none';
});
document.getElementById('gPay').addEventListener('change',e=>{
  const show=e.target.value==="Credito";
  document.getElementById('gTarjLbl').style.display=show?'block':'none';
  document.getElementById('gTarj').style.display=show?'block':'none';
});
document.getElementById('gExtra').addEventListener('change',e=>{
  const show=e.target.value==='si';
  document.getElementById('motivoLbl').style.display=show?'block':'none';
  document.getElementById('motivoTxt').style.display=show?'block':'none';
});

/* === INICIO =============================================================== */
renderUI(); tick(); setInterval(tick,1e3);
</script>
</body>
</html>
