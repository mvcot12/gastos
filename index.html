<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Plan de Viaje</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --glass:rgba(255,255,255,.28);
  --blur:blur(16px);
  --accent:#2f3c7e;
  --p1:#f6f4ff;
  --p2:#d2e4fa;
}
*{box-sizing:border-box}
body{margin:0;padding:1rem;font-family:-apple-system,Helvetica,Arial,sans-serif;
     background:linear-gradient(135deg,var(--p1),var(--p2));color:#222;}
header{backdrop-filter:var(--blur);background:var(--glass);border-radius:20px;
       padding:1rem;margin-bottom:1.2rem;box-shadow:0 4px 20px rgba(0,0,0,.15);}
h1{margin:0;font-size:1.4rem;color:var(--accent)}
.countdown{font-family:monospace;font-size:1rem;text-align:center;margin-top:.4rem}
.grid{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem}
.card{flex:1 1 150px;background:var(--glass);backdrop-filter:var(--blur);
      padding:.9rem;border-radius:18px;text-align:center;box-shadow:0 1px 6px rgba(0,0,0,.12)}
.card h2{margin:.2rem 0;font-size:.95rem;color:var(--accent)}
input,select,button{width:100%;padding:.55rem;margin-top:.35rem;border-radius:12px;
                    border:1px solid #ccc;font-size:.9rem}
button{background:var(--accent);color:#fff;border:none}
details{margin-bottom:1rem}
summary{cursor:pointer;font-weight:600;margin-bottom:.5rem}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{padding:.35rem;border-bottom:1px solid #ddd;text-align:left}
tr.done td{opacity:.5;text-decoration:line-through}
#lista li{margin:.25rem 0}
fieldset{border:none;padding:0;margin:0}
</style>
</head>
<body>

<header>
  <h1>Plan de Viaje</h1>
  <div id="countdown" class="countdown">Cargando‚Ä¶</div>
</header>

<!-- RESUMEN -->
<section class="grid">
  <div class="card"><h2>Presupuesto</h2><span id="sumBudget">$0</span></div>
  <div class="card"><h2>Gastado</h2><span id="sumSpent">$0</span></div>
  <div class="card"><h2>Diferencia</h2><span id="sumDiff">$0</span></div>
  <div class="card"><h2>Extra disp.</h2><span id="sumExtra">$0</span></div>
</section>

<section class="grid">
  <div class="card"><h2>Pichincha saldo</h2><span id="saldoP">$600</span></div>
  <div class="card"><h2>Pac√≠fico saldo</h2><span id="saldoB">$600</span></div>
</section>

<!-- CONFIGURACI√ìN DEL VIAJE -->
<details id="configBox" open>
 <summary>üóìÔ∏è Configurar viaje</summary>
 <fieldset>
  <label>Fecha inicio</label><input type="date" id="tripStart">
  <label>Fecha fin</label><input type="date" id="tripEnd">
  <label>Fecha l√≠mite edici√≥n plan</label><input type="date" id="tripLock">
  <button type="button" onclick="saveTrip()">Guardar viaje</button>
 </fieldset>
</details>

<!-- PLANIFICACI√ìN -->
<details id="planBlock">
 <summary>üìù Planificaci√≥n (hasta fecha l√≠mite)</summary>
 <table id="planTbl">
  <thead><tr><th>Fecha</th><th>Categor√≠a</th><th>Monto</th><th>M√©todo</th><th></th></tr></thead>
  <tbody></tbody>
 </table>
 <fieldset>
  <input type="date" id="pDate">
  <input type="text"  id="pCat" placeholder="Categor√≠a">
  <input type="number" id="pMonto" placeholder="$" step="0.01">
  <select id="pPay">
    <option value="Pichincha">Pichincha</option>
    <option value="Pacifico">Pac√≠fico</option>
    <option value="Efectivo">Efectivo</option>
    <option value="Debito">D√©bito</option>
  </select>
  <button type="button" onclick="addPlan()">A√±adir plan</button>
 </fieldset>
</details>

<!-- GASTO REAL -->
<details id="realBlock" open>
 <summary>‚ûï Registrar gasto real</summary>
 <fieldset>
  <label>Fecha</label><input type="date" id="gDate">
  <label>Categor√≠a</label><input type="text" id="gCat">
  <label>Monto</label><input type="number" id="gAmount" step="0.01">
  <label>M√©todo pago</label>
  <select id="gPay">
    <option value="Pichincha">Pichincha</option>
    <option value="Pacifico">Pac√≠fico</option>
    <option value="Efectivo">Efectivo</option>
    <option value="Debito">D√©bito</option>
  </select>
  <label>¬øUsa extra?</label>
  <select id="gExtra">
    <option value="no">No</option><option value="si">S√≠</option>
  </select>
  <label id="motivoLbl" style="display:none">Motivo extra</label>
  <input  id="motivoTxt" style="display:none">
  <button type="button" onclick="addGasto()">Guardar gasto</button>
 </fieldset>
</details>

<!-- LISTA GASTOS -->
<details>
 <summary>üóíÔ∏è Gastos registrados</summary>
 <ul id="lista"></ul>
</details>

<script>
/* === ESTRUCTURA DE DATOS EN localStorage ===
data = {
  meta:{start:'2025-09-02',end:'2025-09-13',lock:'2025-09-01'},
  plan:[{id,fecha,cat,monto,metodo,done:false}],
  gastos:[{fecha,cat,monto,metodo,extra,motivo}]
}
=============================================*/
const LS='planViajeDataV2';
let data=JSON.parse(localStorage.getItem(LS)||'{"meta":{},"plan":[],"gastos":[]}');

/* === UTILIDADES === */
const fmt=n=>'$'+n.toFixed(2);
function save(){localStorage.setItem(LS,JSON.stringify(data));}

/* === CONFIGURACI√ìN VIAJE === */
function saveTrip(){
  const start=document.getElementById('tripStart').value;
  const end  =document.getElementById('tripEnd').value;
  const lock =document.getElementById('tripLock').value;
  if(!start||!end||!lock){alert('Completa fechas');return;}
  data.meta={start,end,lock}; save(); renderUI(); tick();
}

/* === PLANIFICACI√ìN === */
function addPlan(){
  const f=document.getElementById('pDate').value;
  const c=document.getElementById('pCat').value.trim();
  const m=parseFloat(document.getElementById('pMonto').value||'0');
  const met=document.getElementById('pPay').value;
  if(!f||!c||!m){alert('Completa datos');return;}
  data.plan.push({id:crypto.randomUUID(),fecha:f,cat:c,monto:m,metodo:met,done:false});
  save(); renderPlanTable();
  document.getElementById('pCat').value='';
  document.getElementById('pMonto').value='';
}
function toggleDone(id){
  const p=data.plan.find(x=>x.id===id);
  if(p){p.done=!p.done; save(); renderPlanTable();}
}
function renderPlanTable(){
  const tb=document.querySelector('#planTbl tbody');
  tb.innerHTML='';
  data.plan.sort((a,b)=>a.fecha.localeCompare(b.fecha)).forEach(p=>{
    const tr=document.createElement('tr');
    if(p.done) tr.classList.add('done');
    tr.innerHTML=`<td>${p.fecha}</td><td>${p.cat}</td><td>${fmt(p.monto)}</td>
                  <td>${p.metodo}</td>
                  <td><input type="checkbox" ${p.done?'checked':''}
                         onclick="toggleDone('${p.id}')"></td>`;
    tb.appendChild(tr);
  });
}

/* === GASTO REAL === */
const baseSaldo={Pichincha:600,Pacifico:600};
function updateSummary(){
  let gast=0, extra=0;
  const saldo={...baseSaldo};
  data.gastos.forEach(g=>{
    gast+=g.monto;
    if(g.extra) extra-=g.monto;
    if(saldo[g.metodo]!=null) saldo[g.metodo]-=g.monto;
  });
  /* plan no ejecutado en d√≠as pasados => extra */
  const hoyStr=new Date().toISOString().slice(0,10);
  data.plan.forEach(p=>{
    if(!p.done && p.fecha<hoyStr){p.done=true;extra+=p.monto;}
  });
  document.getElementById('sumBudget').textContent='$0';
  document.getElementById('sumSpent').textContent=fmt(gast);
  document.getElementById('sumDiff').textContent=fmt(-gast);
  document.getElementById('sumExtra').textContent=fmt(extra);
  document.getElementById('saldoP').textContent=fmt(saldo.Pichincha);
  document.getElementById('saldoB').textContent=fmt(saldo.Pacifico);
  save(); renderPlanTable();
}
function renderList(){
  const ul=document.getElementById('lista'); ul.innerHTML='';
  data.gastos.forEach(g=>{
    const li=document.createElement('li');
    li.textContent=`${g.fecha} ‚Ä¢ ${g.cat} ‚Ä¢ ${fmt(g.monto)} ‚Ä¢ ${g.metodo}${g.extra?' ‚Ä¢ extra:'+g.motivo:''}`;
    ul.appendChild(li);
  });
}
function addGasto(){
  const f=document.getElementById('gDate').value;
  const c=document.getElementById('gCat').value.trim();
  const m=parseFloat(document.getElementById('gAmount').value||'0');
  const met=document.getElementById('gPay').value;
  const ex=document.getElementById('gExtra').value==='si';
  const mot=document.getElementById('motivoTxt').value.trim();
  if(!f||!c||!m){alert('Completa datos');return;}
  data.gastos.push({fecha:f,cat:c,monto:m,metodo:met,extra:ex,motivo:mot});
  /* Marcar plan cumplido si coincide fecha y categor√≠a */
  const plan=data.plan.find(p=>!p.done&&p.fecha===f&&p.cat.toLowerCase()===c.toLowerCase());
  if(plan){plan.done=true;}
  save(); renderList(); updateSummary();
  document.getElementById('gCat').value='';
  document.getElementById('gAmount').value='';
  document.getElementById('motivoTxt').value='';
}

/* === Mostrar/esconder motivo extra === */
document.getElementById('gExtra').addEventListener('change',e=>{
  const show=e.target.value==='si';
  document.getElementById('motivoLbl').style.display=show?'block':'none';
  document.getElementById('motivoTxt').style.display=show?'block':'none';
});

/* === Cuenta regresiva === */
function tick(){
  if(!data.meta.start){document.getElementById('countdown').textContent='Sin configuraci√≥n';return;}
  const target=new Date(data.meta.start+'T00:00:00').getTime();
  const now=Date.now(); let diff=target-now;
  const el=document.getElementById('countdown');
  if(diff<=0){el.textContent='¬°Viaje en curso!';return;}
  const d=Math.floor(diff/864e5); diff%=864e5;
  const h=Math.floor(diff/36e5); diff%=36e5;
  const m=Math.floor(diff/6e4); diff%=6e4;
  const s=Math.floor(diff/1e3);
  el.textContent=`${d}d ${h}h ${m}m ${s}s`;
}

/* === Renderizar todo seg√∫n meta === */
function renderUI(){
  /* Cargar campos de meta si existen */
  document.getElementById('tripStart').value=data.meta.start||'';
  document.getElementById('tripEnd').value=data.meta.end||'';
  document.getElementById('tripLock').value=data.meta.lock||'';

  const todayStr=new Date().toISOString().slice(0,10);
  const configBox=document.getElementById('configBox');
  const planBlock=document.getElementById('planBlock');

  /* Bloqueo de edici√≥n plan */
  if(data.meta.lock && todayStr>data.meta.lock){
    planBlock.open=false;
    planBlock.style.display='none';
  }
  renderPlanTable(); renderList(); updateSummary();
}

/* === Init === */
renderUI(); tick(); setInterval(tick,1e3);
</script>
</body>
</html>
